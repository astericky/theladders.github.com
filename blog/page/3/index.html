
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>TheLadders Engineering Stories</title>
  <meta name="author" content="TheLadders Engineering">

  
<<<<<<< HEAD
  <meta name="description" content="You don&#8217;t have to be great to start, but you have to start to be great.&#8211;Zig Ziglar Despite having read through the
several
Clojure
books &hellip;">
=======
  <meta name="description" content="Normal is not something to aspire to, it&#8217;s something to get away from.&#8211;Jodie Foster Scout reads go slow A few weeks ago, as we were about &hellip;">
>>>>>>> upstream/master
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://dev.theladders.com/blog/page/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="TheLadders Engineering Stories" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script type="text/javascript">
var _sf_async_config={uid:14481,domain:"dev.theladders.com"};
(function(){
 function loadChartbeat() {
   window._sf_endpt=(new Date()).getTime();
   var e = document.createElement('script');
   e.setAttribute('language', 'javascript');
   e.setAttribute('type', 'text/javascript');
   e.setAttribute('src',
      (("https:" == document.location.protocol) ? "https://a248.e.akamai.net/chartbeat.download.akamai.com/102508/" : "http://static.chartbeat.com/") +
      "js/chartbeat.js");
   document.body.appendChild(e);
 }
 var oldonload = window.onload;
 window.onload = (typeof window.onload != 'function') ?
    loadChartbeat : function() { oldonload(); loadChartbeat(); };
})();
 
</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-15937967-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
<<<<<<< HEAD
  <header role="banner"><hgroup>
  <h1><a href="/">TheLadders Engineering Stories</a></h1>
  
    <h2>This is how we work.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
=======
	<nav class="main-navigation" role="navigation">
		<div class="container">
			<ul class="subscription" data-subscription="rss">
>>>>>>> upstream/master
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:dev.theladders.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<<<<<<< HEAD
<ul class="main-navigation">
=======
<ul>
>>>>>>> upstream/master
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/ourteam">Our Team</a></li>
</ul>

<<<<<<< HEAD
</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/04/getting-some-clojure-nrepl-in-a-spring-app/">Getting Some Clojure: nREPL in a Spring App</a></h1>
=======

		</div>
	</nav>
	<header class="main-header" role="banner"><div class="container">
	<figure class="logo">
		<a href="/"><img src="/images/skippy_lightbulb.png" alt="TheLadders' Engineering Blog"/></a>
	</figure>
	<hgroup>
		<h1 class="title"><a href="/">TheLadders Engineering Stories</a></h1>
		
		<h2 class="subtitle">This is how we work.</h2>
		
	</hgroup>
</div>

</header>
	<main id="main" class="main">
		<div class="content">
		  <div class="blog-index">
  
  
  
    <article class="article">
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/07/denormalize-the-datas-for-great-good/">Denormalize the Datas for Great Good</a></h1>
>>>>>>> upstream/master
    
    
      <p class="meta">
        








  


<<<<<<< HEAD
<time datetime="2013-04-02T16:04:00-04:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2013</time>
=======
<time datetime="2013-07-08T16:02:00-04:00" pubdate data-updated="true">Jul 8<span>th</span>, 2013</time>
>>>>>>> upstream/master
        
      </p>
    
  </header>


<<<<<<< HEAD
  <div class="entry-content"><blockquote><p>You don&#8217;t have to be great to start, but you have to start to be great.</p><footer><strong>&#8211;Zig Ziglar</strong></footer></blockquote>


<p>Despite having read through the
<a href="http://www.amazon.com/The-Joy-Clojure-Thinking-Way/dp/1935182641/">several</a>
<a href="http://www.amazon.com/Clojure-Action-Amit-Rathore/dp/1935182595/">Clojure</a>
<a href="http://www.amazon.com/Programming-Clojure-Pragmatic-Programmers-Halloway/dp/1934356336/">books</a>
on my shelf and having played around with
<a href="http://www.4clojure.com/">4Clojure</a> (user “wislocki”, ranked 2309th
the last time I checked), I’m not feeling much confidence with the
language yet. We use embedded <a href="http://www.eclipse.org/jetty/">Jetty</a>
to run the website on personal development machines, and I figured it
would be great to be able to play with it interactively in a Clojure
<a href="http://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop">REPL</a>
and get some more hands-on experience.</p>

<p>Practically speaking, since the website is a Java application, a Scala
REPL might make more sense, bridging the gap between the
object-oriented and functional styles more smoothly. But this is a
Clojure-learning exercise, after all.</p>

<p>We’re using
<a href="http://www.springsource.org/spring-framework">Spring 3.1.x</a>, and I
initially looked to see if there was any precedence for combining a
Clojure REPL with Spring. The links I found were mostly out of date or
not relevant.</p>

<p>I decided that I would use
<a href="https://github.com/clojure/tools.nrepl">nREPL</a>, since the
alternative, <a href="https://github.com/technomancy/swank-clojure">Swank</a>, is
no longer maintained. As we’re using
<a href="http://static.springsource.org/spring/docs/3.1.x/spring-framework-reference/html/beans.html#beans-java">Spring’s Java configuration system</a>,
it would have to be started up there. That’s actually pretty
straightforward. Using
<a href="https://github.com/clojure/tools.nrepl#embedding-nrepl-starting-a-server">code</a>
from the nREPL README to start the server, I created the following
Spring configuration class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">theladders</span><span class="o">.</span><span class="na">lw</span><span class="o">.</span><span class="na">config</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.io.StringReader</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.annotation.PostConstruct</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">clojure.lang.Compiler</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">clojure.lang.RT</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Configuration</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NReplConfig</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="c1">// Clojure code to start the server. If you wanted to, you could probably move the port value</span>
</span><span class='line'>  <span class="c1">// into a Java properties file, and use the @Value annotation to provide it instead.</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">NREPL_INIT</span> <span class="o">=</span> <span class="s">&quot;(use &#39;[clojure.tools.nrepl.server :only (start-server stop-server)]) &quot;</span> <span class="o">+</span>
</span><span class='line'>                                           <span class="s">&quot;(start-server :port 7888)&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Inject</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">ApplicationContext</span>  <span class="n">context</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Annotated with @PostConstruct so that this method is run after the object is instantiated and </span>
</span><span class='line'>  <span class="c1">// any other dependency injection has taken place.</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@PostConstruct</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initializeRepl</span><span class="o">()</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="c1">// Load the Clojure Runtime class so that the Compiler can properly use it.</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&quot;clojure.lang.RT&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Start the nREPL server.</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Compiler</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">NREPL_INIT</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Make the Spring context available in the &quot;lw&quot; namespace.</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">RT</span><span class="o">.</span><span class="na">var</span><span class="o">(</span><span class="s">&quot;lw&quot;</span><span class="o">,</span> <span class="s">&quot;*context*&quot;</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>(Thanks to <a href="https://twitter.com/petitlaurent">Laurent Petit</a> of
<a href="https://code.google.com/p/counterclockwise/">counterclockwise</a>-fame
for recommending the above class-loading strategy, as well as the the
suggestion to replace the use of <code>(ns lw)</code> with <code>(in-ns 'lw)</code> in the
REPL example below.)</p>

<p>With this file in place, running <code>mvn jetty:run</code> starts up both the
web server and nREPL. While I could have used
<a href="https://github.com/technomancy/leiningen">Leiningen</a> to connect the
REPL, I decided to use <a href="http://www.gnu.org/software/emacs/">emacs</a>
instead. If you’re using <a href="http://batsov.com/">Bozhidar Batsov</a>’s
<a href="https://github.com/bbatsov/prelude">Prelude configuration</a>, you
already have support for nREPL installed, otherwise you can get it
through <a href="http://melpa.milkbox.net/">MELPA</a> or
<a href="http://marmalade-repo.org/">Marmalade</a> or directly
<a href="https://github.com/kingtim/nrepl.el">here</a>. After a quick <code>M-x
nrepl</code>, I can interact with the running server like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">;</span> <span class="n">nREPL</span> <span class="mf">0.1</span><span class="o">.</span><span class="mi">7</span><span class="o">-</span><span class="n">preview</span>
</span><span class='line'><span class="n">user</span><span class="o">&gt;</span> <span class="o">(</span><span class="n">in</span><span class="o">-</span><span class="n">ns</span> <span class="err">&#39;</span><span class="n">lw</span><span class="o">)</span>
</span><span class='line'><span class="err">#</span><span class="o">&lt;</span><span class="n">Namespace</span> <span class="n">lw</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">lw</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">context</span><span class="o">*</span>
</span><span class='line'><span class="err">#</span><span class="o">&lt;</span><span class="n">AnnotationConfigWebApplicationContext</span> <span class="n">Root</span> <span class="nl">WebApplicationContext:</span> <span class="n">startup</span> <span class="n">date</span> <span class="o">[</span><span class="n">Thu</span> <span class="n">Mar</span> <span class="mi">28</span> <span class="mi">16</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mi">12</span> <span class="n">EDT</span> <span class="mi">2013</span><span class="o">];</span> <span class="n">root</span> <span class="n">of</span> <span class="n">context</span> <span class="n">hierarchy</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">lw</span><span class="o">&gt;</span> <span class="o">(</span><span class="n">def</span> <span class="n">jss</span> <span class="o">(.</span><span class="na">getBean</span> <span class="o">*</span><span class="n">context</span><span class="o">*</span> <span class="n">getBean</span> <span class="s">&quot;jobseekerService&quot;</span><span class="o">))</span>
</span><span class='line'><span class="err">#&#39;</span><span class="n">lw</span><span class="o">/</span><span class="n">jss</span>
</span><span class='line'><span class="n">lw</span><span class="o">&gt;</span> <span class="n">jss</span>
</span><span class='line'><span class="err">#</span><span class="o">&lt;</span><span class="n">JobseekerService</span> <span class="n">com</span><span class="o">.</span><span class="na">theladders</span><span class="o">.</span><span class="na">lw</span><span class="o">.</span><span class="na">jobseeker</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">JobseekerService</span><span class="err">@</span><span class="mi">1</span><span class="n">f4e3b7c</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">lw</span><span class="o">&gt;</span> <span class="o">(</span><span class="n">def</span> <span class="n">jsid</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">theladders</span><span class="o">.</span><span class="na">lw</span><span class="o">.</span><span class="na">jobseeker</span><span class="o">.</span><span class="na">model</span><span class="o">.</span><span class="na">JobseekerId</span><span class="o">.</span> <span class="mi">7906538</span><span class="o">))</span>
</span><span class='line'><span class="err">#&#39;</span><span class="n">lw</span><span class="o">/</span><span class="n">jsid</span>
</span><span class='line'><span class="n">lw</span><span class="o">&gt;</span> <span class="o">(.</span><span class="na">get</span> <span class="n">jss</span> <span class="n">jsid</span><span class="o">)</span>
</span><span class='line'><span class="err">#</span><span class="o">&lt;</span><span class="n">Jobseeker</span> <span class="n">com</span><span class="o">.</span><span class="na">theladders</span><span class="o">.</span><span class="na">lw</span><span class="o">.</span><span class="na">jobseeker</span><span class="o">.</span><span class="na">model</span><span class="o">.</span><span class="na">Jobseeker</span><span class="err">@</span><span class="mi">5</span><span class="n">dfcb9fd</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">lw</span><span class="o">&gt;</span> <span class="o">(.</span><span class="na">getFirstName</span> <span class="o">(.</span><span class="na">get</span> <span class="n">jss</span> <span class="n">jsid</span><span class="o">))</span>
</span><span class='line'><span class="s">&quot;Daniel&quot;</span>
</span><span class='line'><span class="n">lw</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pretty straightforward!</p>

<p>The additions to the <code>pom.xml</code> file that enable nREPL support are below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;repositories&gt;</span>
</span><span class='line'>...
</span><span class='line'>    <span class="c">&lt;!-- The following gives us access to Clojure libraries like clojure-complete. --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;repository&gt;</span>
</span><span class='line'>        <span class="nt">&lt;id&gt;</span>clojars.org<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>        <span class="nt">&lt;url&gt;</span>http://clojars.org/repo<span class="nt">&lt;/url&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/repository&gt;</span>
</span><span class='line'>...
</span><span class='line'><span class="nt">&lt;/repositories&gt;</span>
</span><span class='line'><span class="nt">&lt;dependencies&gt;</span>
</span><span class='line'>...
</span><span class='line'>    <span class="c">&lt;!-- Clojure-complete enables tab-completion in the REPL. --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>clojure-complete<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>clojure-complete<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;version&gt;</span>0.2.3<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>org.clojure<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>clojure<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;version&gt;</span>1.5.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>org.clojure<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>tools.nrepl<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;version&gt;</span>0.2.2<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'>...
</span><span class='line'><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I hope you found this brief write-up useful. I plan on continuing my stumbling exploration, so look for other Clojure-related posts soon.</p>

<p>Join the discussion over on <a href="http://www.reddit.com/r/programming/comments/1bjh69/getting_some_clojure_nrepl_in_a_spring_app/">reddit</a>.</p>

<p><em>April 8th, 2013: Edited in response to suggestions from Laurent Petit.</em></p>
=======
  <div class="entry-content"><blockquote><p>Normal is not something to aspire to, it&#8217;s something to get away from.</p><footer><strong>&#8211;Jodie Foster</strong></footer></blockquote>


<h2>Scout reads go slow</h2>

<p>A few weeks ago, as we were about to launch our <a href="http://app.appsflyer.com/id654867487?pid=TLC_organic">iPhone app</a>, we discovered that one of its core features, Scout, frequently took seconds to render.</p>

<center>
<span class='caption-wrapper small'><img class='caption' src='/images/denormalize-the-datas-for-great-good/scout-screenshot.png' width='' height='' alt='Scout' title='Scout'><span class='caption-text'>Scout</span></span> 
</center>


<p>For a little background as to what Scout is, at TheLadders our mission is to find the right person for the right job. One of the ways we strive to deliver on that promise is to provide jobseekers information about jobs they’ll find nowhere else. Serving that mission is Scout, which in a nutshell allows jobseekers to view anonymized information about applicants who have applied to the job they are viewing. Salary, education, career history: we present a lot of useful information to jobseekers about their competition for any given job.</p>

<p>Over time, some attractive jobs accumulate on the order of 30 to 60 applicants, yielding response times of over 1 second (due to multiple synchronous requests, done serially, just to serve <em>one</em> Scout view request).  In cases of higher load, sometimes request times take well over that.</p>

<center>
<span class='caption-wrapper small'><img class='caption' src='/images/denormalize-the-datas-for-great-good/scout-screenshot-many-applies.png' width='' height='' alt='Scout view of a job with many applicants' title='Scout view of a job with many applicants'><span class='caption-text'>Scout view of a job with many applicants</span></span> 
</center>


<p>That brings Scout into unusably slow country, as the Graphite chart below indicates:</p>

<center>
<span class='caption-wrapper medium'><img class='caption' src='/images/denormalize-the-datas-for-great-good/before-graphite.png' width='' height='' alt='95th percentile of response times for Scout in seconds' title='95th percentile of response times for Scout in seconds'><span class='caption-text'>95th percentile of response times for Scout in seconds</span></span>
</center>


<p>The graph shows the time it takes to form a response to a view-job request issued by our iPhone app. It’s the 95th percentile, which means that 5% of requests had times of the lines in the graph or higher for any given date.  One in twenty requests took this long or longer. There are many lines because we have a horizontally scalable architecture, so there are many backend app nodes.</p>

<p>We managed to bring those seconds down to milliseconds, with about a 1000x decrease in times of high load.  Below I’ll describe the changes in our architecture that enabled us to make such a huge improvement.</p>

<hr />

<h2>Architecture</h2>

<p>In its initial implementation, Scout’s applicant information was gathered and assembled on the fly for each and every request. Driving the iPhone app, we have a backend app server, which is essentially just a number of RESTful endpoints against which our iPhone app issues requests.  Below is a quick rundown of the architecture before I trace a request through our architecture.</p>

<center>
<span class='caption-wrapper medium'><img class='caption' src='/images/denormalize-the-datas-for-great-good/front-end-orchestration.png' width='' height='' alt='iPhone app talks to the backend app server' title='iPhone app talks to the backend app server'><span class='caption-text'>iPhone app talks to the backend app server</span></span>
</center>


<p>Below this backend server there are a number of RESTful entity servers with which the app server is interacting via HTTP.</p>

<p><span class='caption-wrapper center medium'><img class='caption' src='/images/denormalize-the-datas-for-great-good/front-end-orchestration-entity.png' width='' height='' alt='Backend app server relies on entity servers' title='Backend app server relies on entity servers'><span class='caption-text'>Backend app server relies on entity servers</span></span></p>

<p>These entity servers in turn query each other and the canonical data store, in our case Clustrix, and that’s that.</p>

<p><span class='caption-wrapper center medium'><img class='caption' src='/images/denormalize-the-datas-for-great-good/front-end-orchestration-entity-clustrix.png' width='' height='' alt='Entity servers query the db' title='Entity servers query the db'><span class='caption-text'>Entity servers query the db</span></span></p>

<p>So when a user of our iPhone app taps on a job, a request is sent to the backend app server&hellip;</p>

<p><img class="center medium" src="/images/denormalize-the-datas-for-great-good/mobile-orchestration-request.png" title="iPhone app makes a request" ></p>

<p>&hellip;which then issues a request to our job application service for all job applications for that job. The response contains a number of links to the where those job applications may be retrieved.</p>

<p><img class="center medium" src="/images/denormalize-the-datas-for-great-good/mobile-orchestration-service-request.png" title="backend server queries the job application service for all applications to a job" ></p>

<p>The backend server iterates over those links, requesting the job applications themselves one at a time. Just as before, adhering to hypermedia design, the response contains a link to the jobseeker who applied to the job. For your sanity, I’ve simplified the response to contain only the job seeker link:</p>

<p><img class="center medium" src="/images/denormalize-the-datas-for-great-good/mobile-orchestration-service-request2.png" title="backend retrieves each application" ></p>

<p>Finally with that result set, the orchestration service then issues a number of requests to the job seeker service for information about the job seekers who have applied to the job being viewed.  In its initial implementation all of the requests were synchronous and in series as I mentioned earlier. We eventually parallelized them, as you can see in the Graphite chart where the big spikes left diminish towards the right.</p>

<p><img class="center medium" src="/images/denormalize-the-datas-for-great-good/mobile-orchestration-service-request3.png" title="backend retrieves each application" ></p>

<p>The iPhone app backend server then extracts the relevant information from those job seekers’ profiles, and returns them as a JSON array of applicants to the mobile app.</p>

<p><img class="center medium" src="/images/denormalize-the-datas-for-great-good/mobile-orchestration-response.png" title="backend retrieves each application" ></p>

<p>That is not just a lot of words and diagrams, that is a lot of work!</p>

<p>The workflow includes multiple objects serializing and deserializing, HTTP transfers, hitting the canonical store etc. Why does each request need to assemble this data itself? Why bother hitting the database? Is there an alternative? It seems like a natural fit for a document-oriented database, as the data we are passing back to the client is just a JSON object containing an array of applicants.  We could stand a <a href="http://dev.theladders.com/2013/05/varnish-in-five-acts/">Varnish cache</a> in front of the Scout endpoints on the orchestration service, but then we’d be trading freshness for speed. On the platform team we like to deliver data fast and fresh (and furious).</p>

<p><img class="center" src="/images/denormalize-the-datas-for-great-good/tokyo-drift-o.gif" title="how we roll at the Democratic Republic of Platformia" ></p>

<hr />

<h2>Scout reads go fast</h2>

<p>Principal Architect <a href="http://twitter.com/SeanTAllen">Sean T Allen</a> set <a href="http://twitter.com/casio_juarez">Andy Turley</a> and me to improving Scout’s performance. The architecture is surprisingly simple: stick the data in <a href="http://www.couchbase.com/">Couchbase</a> and have the iPhone app backend query that instead. How would we keep this data up-to-date? The first step is to have the job application entity service emit a RabbitMQ event when it receives an application from a job seeker to a particular job (a PUT returning a 201).  On the other end of that message queue there is a  <a href="http://dev.theladders.com/2013/03/riders-on-the-storm-take-a-long-holiday-let-your-children-play/">Storm</a> topology that should listen for that message. The RabbitMQ message would be the entry point into the spout.</p>

<p>The message contains a link to the job seeker who applied to the job, as well as the ID for the job to which she applied.   The message isn’t actually encoded as JSON and transmitted over the wire, but for clarity I’ve displayed the RabbitMQ message as JSON.</p>

<p><img class="center" src="/images/denormalize-the-datas-for-great-good/rabbitmq-storm.png" title="RabbitMQ passes along a job-application message to a listening Storm topology" ></p>

<p>The second step, after having received the RabbitMQ message, fetches the job seeker profile from the jobseeker service, and passes that information to the next step.</p>

<p><img class="center" src="/images/denormalize-the-datas-for-great-good/rabbitmq-storm-jobseeker.png" title="The Storm topology extracts the job seeker link from the messages and retrieves information about the job seeker who just applied to the job." ></p>

<p>This third step is responsible for persisting the applicant information to a Couchbase bucket. It uses the job ID as the key, and it does a create or update operation on the document corresponding to that key depending on whether there are applicants already in the bucket for that job.</p>

<p><img class="center" src="/images/denormalize-the-datas-for-great-good/rabbitmq-storm-couchbase.png" title="The final step is that the topology persists the relevant job" ></p>

<p>That last diagram is a bit of a simplification. Although Couchbase is &ldquo;JSON-aware&rdquo;, it lacks the ability to perform certain operations on the JSON documents it stores.  For example, if the document being stored is an Array, and the client&rsquo;s append method is called, we hoped that Couchbase would add that element to the end of the Array. Instead, it&rsquo;s just a blind String.append, resulting in an invalid JSON document. As a result, we had to implement our own append operation by reading the document (if it exists), adding an item to a list if it’s not already there, and then writing the document.  So it’s more like two operations than one.</p>

<p><em>Now</em> when TheLadders mobile service gets a request for Scout information for a job, all it does is a lookup in Couchbase with that job ID and returns the applicants associated with that key.</p>

<p><img class="center" src="/images/denormalize-the-datas-for-great-good/mobile-orchestration-couchbase.png" title="iPhone issues a request for Scout information, backend just retrieves it from couchbase" ></p>

<p><span class='caption-wrapper center'><img class='caption' src='/images/denormalize-the-datas-for-great-good/before-couchbase-after-no-lines.png' width='' height='' alt='95th percentile response time for Scout data, before and after moving to the read view' title='95th percentile response time for Scout data, before and after moving to the read view'><span class='caption-text'>95th percentile response time for Scout data, before and after moving to the read view</span></span></p>

<p>Dramatically faster, even at the 95th percentile.</p>

<hr />

<p>SOA is no panacea. There are many instances where querying a number of backend servers to assemble and aggregate data returned from a database simply doesn&rsquo;t make sense. In those cases, you may do well to denormalize that data and put it in a store that&rsquo;s more efficient for retrieval.</p>

<p>If you find this post interesting, join the dicussion over on <a href="https://news.ycombinator.com/item?id=6015123">Hacker News</a>.</p>
>>>>>>> upstream/master
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
<<<<<<< HEAD
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
=======
    <a class="archives" href="/blog/archives">Blog Archives</a>
    
      <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div> 
</div>


		</div>
	</main>
	<aside class="sidebar">
		
		<section>
>>>>>>> upstream/master
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
<<<<<<< HEAD
        <a href="/2013/05/the-evolution-of-qa-at-theladders/">The Evolution of QA at TheLadders</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/varnish-in-five-acts/">Varnish in Five Acts</a>
      </li>
    
      <li class="post">
        <a href="/2013/04/getting-some-clojure-nrepl-in-a-spring-app/">Getting Some Clojure: nREPL in a Spring App</a>
      </li>
    
      <li class="post">
        <a href="/2013/03/theladders-on-boarding-a-retrospective/">TheLadders Onboarding: A Retrospective</a>
      </li>
    
      <li class="post">
        <a href="/2013/03/trouble-with-googles-immutableset/">Trouble with Google&#8217;s ImmutableSet</a>
=======
        <a href="/2013/10/responsive-design-keeping-our-thick-client-skinny/">Responsive Design: Keeping our thick client skinny</a>
      </li>
    
      <li class="post">
        <a href="/2013/08/were-hosting-erlang-factory-lite/">We're Hosting the first NYC Erlang Factory Lite on September 14th</a>
      </li>
    
      <li class="post">
        <a href="/2013/07/denormalize-the-datas-for-great-good/">Denormalize the Datas for Great Good</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/the-evolution-of-qa-at-theladders/">The Evolution of QA at TheLadders</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/varnish-in-five-acts/">Varnish in Five Acts</a>
>>>>>>> upstream/master
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
<<<<<<< HEAD
    <li class="loading">Status updating&#8230;</li>
=======
    <li class="loading">Status updating...</li>
>>>>>>> upstream/master
  </ul>
  
  <a href="https://github.com/TheLadders">@TheLadders</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'TheLadders',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<<<<<<< HEAD
<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("TheLaddersDev", 3, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/TheLaddersDev" class="twitter-follow-button" data-show-count="false">Follow @TheLaddersDev</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - TheLadders Engineering -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  
=======



		
	</aside>
	<footer class="footer" role="contentinfo"><div class="container">
	<p>
		Copyright &copy; 2013 - TheLadders Engineering -
		<span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
	</p>
</div>

</footer>
	
>>>>>>> upstream/master



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
